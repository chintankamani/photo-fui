<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>PhotoEdit.io</title>
  <link type="text/css" href="https://uicdn.toast.com/tui-color-picker/v2.2.6/tui-color-picker.css" rel="stylesheet" />
  <link type="text/css" href="https://uicdn.toast.com/tui-image-editor/latest/tui-image-editor.css" rel="stylesheet" />
  <style>
    :root {
      --bg-page: #f7f7f7;
      --bg-card: #ffffff;
      --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --primary: #f43f5e;
      --secondary: #22c55e;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body { display: flex; flex-direction: column; min-height: 100vh; font-family: system-ui, sans-serif; color: #111; background: var(--bg-page); }
    a { text-decoration: none; color: inherit; }
    button { background: none; border: none; cursor: pointer; font: inherit; }
    header { display: flex; justify-content: space-between; align-items: flex-start; padding: 20px 40px; }
    .logo-title { display: flex; flex-direction: column; }
    .logo-title .title { font-size: 24px; font-weight: bold; }
    .logo-title .subtitle { font-size: 14px; color: #555; margin-top: 4px; }
    .start-link { margin-top: 8px; font-size: 14px; color: var(--secondary); font-weight: 500; }
    main { flex: 1; overflow-y: auto; padding: 0 40px; }
    h3 { font-size: 12px; letter-spacing: 1px; color: #555; margin-bottom: 8px; text-transform: uppercase; }
    .section { margin-top: 20px; }
    .cards { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { background: var(--bg-card); min-width: 100px; padding: 12px; border-radius: 8px; box-shadow: var(--shadow-xs), var(--shadow-sm); position: relative; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; }
    .card:hover { box-shadow: var(--shadow-sm), var(--shadow-md); }
    .card .indicator { position: absolute; bottom: 8px; left: 8px; width: 8px; height: 8px; border-radius: 50%; background: #ddd; }
    .card.selected .indicator { background: var(--primary); }
    .card .icon { position: absolute; bottom: 6px; right: 6px; font-size: 10px; color: #888; }
    .filter-cards .card { width: 100px; height: 80px; }
    .adjustment-cards .card { width: 120px; height: 80px; }
    .random-card { background: #e5e7eb; color: #555; }
    .random-card .indicator { display: none; }
    .layout { display: flex; gap: 40px; margin-top: 20px; }
    .left-panel { flex: 1.1; display: flex; flex-direction: column; }
    .right-panel { flex: 2; display: flex; flex-direction: column; }

    .tui-image-editor-container {
      width: 100%;
      height: 500px;
      background: var(--bg-card);
      padding: 16px;
      border-radius: 8px;
      box-shadow: var(--shadow-xs), var(--shadow-sm);
    }

    .tui-image-editor-main {
      position: relative;
    }

    #tui-image-editor {
      width: 100%;
      height: 480px;
    }

    .upload-zone {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      position: absolute;
      top: 0;
      left: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: 100;
    }

    .upload-zone.hidden {
      display: none;
    }

    .upload-zone svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      color: #888;
    }

    .upload-zone p {
      font-size: 14px;
      color: #777;
      margin-bottom: 16px;
    }

    .upload-btn {
      background: var(--bg-card);
      color: #333;
      border: 1px solid #ddd;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }

    .upload-btn:hover {
      background: #f0f0f0;
    }

    .file-input {
      display: none;
    }

    footer { display: flex; gap: 12px; padding: 20px 40px; }
    .btn { flex: 1; display: flex; align-items: center; justify-content: center; padding: 12px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; gap: 8px; cursor: pointer; }
    .btn.download { background: #fff; color: #111; box-shadow: var(--shadow-xs), var(--shadow-sm); }
    .btn.reset { background: #111; color: #fff; }
    .btn.save { background: var(--primary); color: #fff; flex: 2; }
    .btn svg { width: 16px; height: 16px; fill: currentColor; }

    .btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    /* Export format selector styling */
    .format-select {
      flex: 0 0 100px;
      width: 100px;
      padding: 12px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: var(--bg-card);
      color: #111;
      cursor: pointer;
    }

    /* Custom styling for filter thumbnails */
    .filter-thumb {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      background-size: cover;
      background-position: center;
      opacity: 0.6;
      border-radius: 4px;
      z-index: -1;
    }

    /* Adjustment control styles */
    .adjustment-controls {
      background: var(--bg-card);
      padding: 16px;
      border-radius: 8px;
      box-shadow: var(--shadow-xs), var(--shadow-sm);
      margin-top: 20px;
    }

    .control-group {
      margin-bottom: 12px;
    }

    .control-group label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #555;
    }

    .control-group input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 4px;
      background: #ddd;
      border-radius: 2px;
      outline: none;
      margin: 4px 0 8px;
    }

    .control-group input[type="range"]::-webkit-slider-runnable-track {
      width: 100%;
      height: 4px;
      background: #ddd;
      border-radius: 2px;
    }
    .control-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: var(--primary);
      border: 2px solid #fff;
      border-radius: 50%;
      cursor: pointer;
      margin-top: -5px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .control-group input[type="range"]::-moz-range-track {
      width: 100%;
      height: 4px;
      background: #ddd;
      border-radius: 2px;
    }
    .control-group input[type="range"]::-moz-range-thumb {
      width: 14px;
      height: 14px;
      background: var(--primary);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .control-group input[type="range"]::-ms-track {
      width: 100%;
      height: 4px;
      background: transparent;
      border-color: transparent;
      color: transparent;
    }
    .control-group input[type="range"]::-ms-fill-lower {
      background: #ddd;
      border-radius: 2px;
    }
    .control-group input[type="range"]::-ms-fill-upper {
      background: #ddd;
      border-radius: 2px;
    }
    .control-group input[type="range"]::-ms-thumb {
      width: 14px;
      height: 14px;
      background: var(--primary);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      margin-top: 0;
    }

    .control-value {
      font-size: 12px;
      color: #777;
      text-align: right;
    }

    /* Small buttons in adjustment controls */
    .adjustment-controls .btn {
      margin-top: 8px;
      margin-bottom: 8px;
      padding: 8px 12px;
      font-size: 12px;
    }
    /* Crop controls: line up buttons like footer buttons */
    #crop-controls {
      display: flex;
      gap: 8px;
    }
    #crop-controls .btn {
      margin: 0;
      flex: 1;
      /* match footer buttons style */
      padding: 12px 16px;
      font-size: 14px;
    }

    /* Custom TUI editor overrides */
    .tui-image-editor-container .tui-image-editor-header {
      display: none !important;
    }

    .tui-image-editor-container .tui-image-editor-main-container {
      top: 0 !important;
    }

    /* Hide TUI's default menu */
    .tui-image-editor-container .tui-image-editor-menu {
      display: none !important;
    }
    /* Inset the editor main area by 10px */
    .tui-image-editor-container .tui-image-editor-main {
      inset: 10px !important;
    }

    .tui-image-editor-canvas-container {
      border-radius: 8px;
      overflow: hidden;
    }

    /* Color picker customization */
    .tui-colorpicker-container {
      margin-top: 8px;
    }

    /* Notification style */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      left: auto;
      transform: none;
      background: #fff;
      color: #111;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: var(--shadow-xs), var(--shadow-sm);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .notification.visible {
      opacity: 1;
    }
    /* Progress overlay and spinner */
    #progress-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 1000;
    }
    #progress-overlay.visible {
      display: flex;
    }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--primary);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }
    #progress-message {
      font-size: 14px;
      color: #111;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Crop overlay */
    #crop-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: none;
      cursor: crosshair;
      z-index: 10;
    }
    .crop-rect {
      position: absolute;
      border: 2px dashed #fff;
      background: rgba(255,255,255,0.3);
      /* Allow overlay to capture mouse events, not the rectangle */
      pointer-events: none;
    }

    /* Menu buttons (Load, Undo, Redo) */
    .menu-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .menu-btn {
      background: var(--bg-card);
      padding: 8px 16px;
      border-radius: 8px;
      box-shadow: var(--shadow-xs), var(--shadow-sm);
      font-size: 14px;
      cursor: pointer;
    }

    .menu-btn:hover {
      background: #f0f0f0;
    }

    .menu-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    /* Zoom buttons styling */
    .zoom-section .menu-btn {
      font-size: 18px;
      padding: 12px 24px;
    }
    /* Zoom controls container adjustments */
    .menu-buttons.zoom-controls {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .menu-buttons.zoom-controls .zoom-btn {
      flex: 1;
    }
    /* Zoom value styling */
    .menu-buttons.zoom-controls #zoom-value {
      flex: 1;
      text-align: center;
      font-size: 18px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-title">
      <div class="title">PhotoEdit.io</div>
      <div class="subtitle">An interactive photo editing tool with professional filters and adjustments.</div>
      <a href="#" class="start-link" id="start-editing">START EDITING →</a>
    </div>
  </header>
  <main>
    <div class="menu-buttons">
      <button class="menu-btn" id="btn-load">Load</button>
    </div>

    <div class="section">
      <h3>FILTERS</h3>
      <div class="cards filter-cards">
        <div class="card" data-filter="normal">Normal<div class="filter-thumb"></div><span class="indicator"></span></div>
        <div class="card" data-filter="vintage">Vintage<div class="filter-thumb"></div><span class="indicator"></span></div>
        <div class="card" data-filter="grayscale">B&W<div class="filter-thumb"></div><span class="indicator"></span><span class="icon">◇</span></div>
        <div class="card" data-filter="sepia">Sepia<div class="filter-thumb"></div><span class="indicator"></span></div>
        <div class="card" data-filter="sepia2">Sepia2<div class="filter-thumb"></div><span class="indicator"></span></div>
        <div class="card" data-filter="blur">Blur<div class="filter-thumb"></div><span class="indicator"></span><span class="icon">◇</span></div>
        <div class="card" data-filter="sharpen">Sharpen<div class="filter-thumb"></div><span class="indicator"></span></div>
        <div class="card" data-filter="emboss">Emboss<div class="filter-thumb"></div><span class="indicator"></span></div>
        <div class="card" data-filter="invert">Invert<div class="filter-thumb"></div><span class="indicator"></span><span class="icon">◇</span></div>
        <!-- Removed Bright and Noise filters -->
        <div class="card" data-filter="bg-remove">BG Remove<div class="filter-thumb"></div><span class="indicator"></span><span class="icon">✂</span></div>
        <div class="card random-card"><span class="icon">↻</span></div>
      </div>
    </div>
    <div class="layout">
      <div class="left-panel">
        <div class="section">
          <h3>ADJUSTMENTS</h3>
          <div class="cards adjustment-cards">
            <div class="card selected" data-adjustment="basic">Basic<span class="indicator"></span></div>
            <div class="card" data-adjustment="color">Color<span class="indicator"></span></div>
            <div class="card" data-adjustment="crop">Crop<span class="indicator"></span></div>
            <div class="card" data-adjustment="rotate">Rotate<span class="indicator"></span></div>
          </div>
        </div>

        <div class="adjustment-controls" id="basic-controls">
          <div class="control-group">
            <label for="brightness">Brightness</label>
            <input type="range" id="brightness" min="-255" max="255" value="0" step="1">
            <div class="control-value">0</div>
          </div>
          <div class="control-group">
            <label for="contrast">Contrast</label>
            <input type="range" id="contrast" min="-100" max="100" value="0" step="1">
            <div class="control-value">0</div>
          </div>
          <div class="control-group">
            <label for="saturation">Saturation</label>
            <input type="range" id="saturation" min="-100" max="100" value="0" step="1">
            <div class="control-value">0</div>
          </div>
        </div>

        <div class="adjustment-controls" id="color-controls" style="display: none;">
          <div class="control-group">
            <label for="vibrance">Vibrance</label>
            <input type="range" id="vibrance" min="0" max="100" value="0" step="1">
            <div class="control-value">0</div>
          </div>
          <div class="control-group">
            <label for="noise">Noise</label>
            <input type="range" id="noise" min="0" max="1000" value="0" step="10">
            <div class="control-value">0</div>
          </div>
          <div class="control-group">
            <label for="pixelate">Pixelate</label>
            <input type="range" id="pixelate" min="1" max="20" value="1" step="1">
            <div class="control-value">1</div>
          </div>
        </div>

        <div class="adjustment-controls" id="crop-controls" style="display: none;">
          <button class="btn save" id="btn-apply-crop">Apply Crop</button>
          <button class="btn reset" id="btn-cancel-crop">Cancel</button>
        </div>

        <div class="adjustment-controls" id="rotate-controls" style="display: none;">
          <div class="control-group">
            <label for="rotation-angle">Rotation Angle</label>
            <input type="range" id="rotation-angle" min="-180" max="180" value="0" step="1">
            <div class="control-value">0°</div>
          </div>
          <button class="btn" id="btn-rotate-left">Rotate 90° Left</button>
          <button class="btn" id="btn-rotate-right">Rotate 90° Right</button>
          <button class="btn" id="btn-flip-x">Flip Horizontal</button>
          <button class="btn" id="btn-flip-y">Flip Vertical</button>
        </div>

        <div class="adjustment-controls" id="draw-controls" style="display: none;">
          <div class="control-group">
            <label for="brush-width">Brush Width</label>
            <input type="range" id="brush-width" min="1" max="30" value="12" step="1">
            <div class="control-value">12</div>
          </div>
          <div class="control-group">
            <label>Brush Color</label>
            <div id="color-picker-container"></div>
          </div>
          <button class="btn" id="btn-free-drawing">Free Drawing</button>
          <button class="btn" id="btn-line-drawing">Line Drawing</button>
        </div>
        <div class="section zoom-section">
          <h3>Image Zoom</h3>
          <div class="menu-buttons zoom-controls" style="margin-bottom:8px;">
            <button class="menu-btn zoom-btn" id="btn-zoom-out">-</button>
            <span id="zoom-value">100%</span>
            <button class="menu-btn zoom-btn" id="btn-zoom-in">+</button>
          </div>
        </div>
      </div>

      <div class="right-panel">
        <div class="section">
          <h3>EDITOR</h3>
          <!-- Zoom controls moved to Adjustment panel -->
          <div class="tui-image-editor-container">
            <div class="tui-image-editor-main">
              <canvas id="canvas" width="700" height="500"></canvas>
              <div id="crop-overlay"></div>
              <div class="upload-zone" id="upload-zone">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p>Drag and drop your photo here<br>or</p>
                <button class="upload-btn" id="upload-btn">Choose a file</button>
                <input type="file" class="file-input" id="file-input" accept="image/*">
              </div>
            </div>
            <!-- Progress overlay -->
            <div id="progress-overlay">
              <div class="spinner"></div>
              <div id="progress-message">Loading...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <footer>
    <select id="export-format" class="format-select">
      <option value="image/png">PNG</option>
      <option value="image/jpeg">JPEG</option>
      <option value="image/webp">WEBP</option>
    </select>
    <button class="btn reset disabled" id="reset-btn">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M17.65 6.35c-1.45-1.45-3.44-2.35-5.65-2.35-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78l-3.22 3.22h7v-7l-2.35 2.35z"/></svg>
      Reset
    </button>
    <button class="btn save disabled" id="save-btn">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm2 16H5V5h11.17L19 7.83V19zm-7-7c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zM6 6h9v4H6z"/></svg>
      Save Edit
    </button>
  </footer>

  <!-- Required scripts for TUI Image Editor -->
  <script src="https://uicdn.toast.com/tui.code-snippet/v1.5.0/tui-code-snippet.min.js"></script>
  <script src="https://uicdn.toast.com/tui-color-picker/v2.2.6/tui-color-picker.min.js"></script>
  <script src="https://api-storage.cloud.toast.com/v1/AUTH_e18353c4ea5746c097143946d0644e61/toast-ui-cdn/tui-image-editor/v3.11.0/example/fabric-v4.2.0.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
  <script src="https://uicdn.toast.com/tui-image-editor/latest/tui-image-editor.js"></script>

  <script type="text/plain">
    document.addEventListener('DOMContentLoaded', function() {
      // DOM Elements
      const fileInput = document.getElementById('file-input');
      const uploadBtn = document.getElementById('upload-btn');
      const uploadZone = document.getElementById('upload-zone');
      const downloadBtn = document.getElementById('download-btn');
      const resetBtn = document.getElementById('reset-btn');
      const saveBtn = document.getElementById('save-btn');
      const startEditing = document.getElementById('start-editing');
      const filterCards = document.querySelectorAll('.filter-cards .card:not(.random-card)');
      const adjustmentCards = document.querySelectorAll('.adjustment-cards .card:not(.random-card)');
      const adjustmentControls = document.querySelectorAll('.adjustment-controls');
      const btnLoad = document.getElementById('btn-load');

      // Global variables
      let imageEditor = null;
      let originalImageUrl = null;
      let tempEditors = []; // Track temporary editors for cleanup

      // Initialize the TUI Image Editor with proper configuration
      function initImageEditor() {
        // Clear any existing instance
        if (imageEditor) {
          try {
            imageEditor.destroy();
          } catch (err) {
            console.error('Error destroying previous editor instance:', err);
          }
        }

        // Create new instance with proper configuration
        try {
          imageEditor = new tui.ImageEditor('#tui-image-editor', {
            includeUI: {
              loadImage: {
                path: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7',
                name: 'Blank'
              },
              theme: {
                // Main canvas theme
                'common.backgroundColor': '#f7f7f7',
                'common.border': '0px',

                // Header theme
                'header.backgroundColor': 'transparent',
                'header.borderBottom': '0px',
                'header.display': 'none',

                // Icon theme
                'menu.normalIcon.path': 'https://uicdn.toast.com/tui-image-editor/latest/examples/img/icon-d.svg',
                'menu.normalIcon.name': 'icon-d',
                'menu.activeIcon.path': 'https://uicdn.toast.com/tui-image-editor/latest/examples/img/icon-b.svg',
                'menu.activeIcon.name': 'icon-b',
                'menu.iconSize.width': '24px',
                'menu.iconSize.height': '24px',

                // Sub menu theme
                'submenu.backgroundColor': 'transparent',
                'submenu.partition.color': '#e5e5e5',

                // Main icon theme
                'submenu.normalIcon.path': 'https://uicdn.toast.com/tui-image-editor/latest/examples/img/icon-d.svg',
                'submenu.normalIcon.name': 'icon-d',
                'submenu.activeIcon.path': 'https://uicdn.toast.com/tui-image-editor/latest/examples/img/icon-b.svg',
                'submenu.activeIcon.name': 'icon-b',

                // Button theme
                'submenu.button.border': '0px',
                'submenu.button.backgroundColor': 'transparent',
              },
              menu: ['crop', 'flip', 'rotate', 'shape', 'icon', 'text', 'mask', 'filter'],
              initMenu: 'filter',
              uiSize: {
                width: '100%',
                height: '100%'
              },
              menuBarPosition: 'bottom'
            },
            cssMaxWidth: 700,
            cssMaxHeight: 500,
            selectionStyle: {
              cornerSize: 20,
              rotatingPointOffset: 70
            },
            usageStatistics: false
          });
        } catch (err) {
          console.error('Error initializing editor:', err);
          alert('Error initializing editor. Please reload the page.');
          return null;
        }

        // Hide TUI's default menu if it exists
        setTimeout(() => {
          const tuiMenu = document.querySelector('.tui-image-editor-menu');
          if (tuiMenu) tuiMenu.style.display = 'none';
        }, 100);

        // Setup event listeners for the editor
        if (imageEditor) {
          imageEditor.on('objectActivated', function(props) {
            console.log('Object activated:', props);
          });

          imageEditor.on('objectMoved', function(props) {
            console.log('Object moved:', props);
          });

          imageEditor.on('objectScaled', function(props) {
            console.log('Object scaled:', props);
          });

          imageEditor.on('redoStackChanged', function(props) {
            // Enable/disable redo button based on availability
            btnRedo.classList.toggle('disabled', !imageEditor.hasRedoStack());
          });

          imageEditor.on('undoStackChanged', function(props) {
            // Enable/disable undo button based on availability
            btnUndo.classList.toggle('disabled', !imageEditor.hasUndoStack());
          });
        }

        return imageEditor;
      }

      // Initialize image editor
      imageEditor = initImageEditor();

      // Show a notification message
      function showNotification(message) {
        // Remove any existing notification
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
          existingNotification.remove();
        }

        // Create new notification
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        document.body.appendChild(notification);

        // Show notification
        setTimeout(() => {
          notification.classList.add('visible');
        }, 10);

        // Remove notification after a delay
        setTimeout(() => {
          notification.classList.remove('visible');
          setTimeout(() => {
            notification.remove();
          }, 300);
        }, 3000);
      }


      // Upload functionality
      if (uploadBtn) {
        uploadBtn.onclick = function() {
          if (fileInput) {
            fileInput.click();
          }
        };
      }

      if (fileInput) {
        fileInput.onchange = function(e) {
          if (e.target.files && e.target.files.length) {
            handleFile(e.target.files[0]);
          }
        };
      }

      if (uploadZone) {
        uploadZone.ondragover = function(e) {
          e.preventDefault();
          e.stopPropagation();
          uploadZone.style.borderColor = 'var(--primary)';
          return false;
        };

        uploadZone.ondragleave = function(e) {
          e.preventDefault();
          e.stopPropagation();
          uploadZone.style.borderColor = '#ddd';
          return false;
        };

        uploadZone.ondrop = function(e) {
          e.preventDefault();
          e.stopPropagation();
          uploadZone.style.borderColor = '#ddd';
          if (e.dataTransfer.files && e.dataTransfer.files.length) {
            handleFile(e.dataTransfer.files[0]);
          }
          return false;
        };

      }

      // Trigger file selector from Load and Start Editing buttons
      if (startEditing) {
        startEditing.addEventListener('click', function(e) {
          e.preventDefault();
          if (fileInput) fileInput.click();
        });
      }
      if (btnLoad) {
        btnLoad.addEventListener('click', function(e) {
          e.preventDefault();
          if (fileInput) fileInput.click();
        });
      }

      // Handle selected or dropped file
      function handleFile(file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const dataURL = event.target.result;
          if (uploadZone) uploadZone.classList.add('hidden');
          originalImageUrl = dataURL;
          if (imageEditor) {
            imageEditor.loadImageFromURL(dataURL, file.name || 'Image')
              .then(() => {
                showNotification('Image loaded');
                if (downloadBtn) downloadBtn.classList.remove('disabled');
                if (resetBtn) resetBtn.classList.remove('disabled');
                if (saveBtn) saveBtn.classList.remove('disabled');
                if (btnUndo) btnUndo.classList.add('disabled');
                if (btnRedo) btnRedo.classList.add('disabled');
              })
              .catch(err => {
                console.error('Error loading image:', err);
                showNotification('Failed to load image');
              });
          }
        };
        reader.readAsDataURL(file);
      }

    });
  </script>
  <!-- Click and slider sound effects -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const audioCtx = new AudioCtx();
      function playTone(freq, duration, volume) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(volume, audioCtx.currentTime);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
      }
      // Play click on card clicks
      document.querySelectorAll('.card').forEach(el => {
        el.addEventListener('click', () => playTone(600, 0.05, 0.1));
      });
      // Play slider sound on range inputs
      document.querySelectorAll('input[type="range"]').forEach(el => {
        el.addEventListener('input', () => playTone(300, 0.02, 0.05));
      });
      // Play click on zoom in/out buttons
      document.querySelectorAll('.zoom-btn').forEach(el => {
        el.addEventListener('click', () => playTone(600, 0.05, 0.1));
      });
      // Play click on Load button
      const loadBtn = document.getElementById('btn-load');
      if (loadBtn) {
        loadBtn.addEventListener('click', () => playTone(700, 0.07, 0.1));
      }
      // Play 'completed' sound on action buttons (excluding save and reset)
      document.querySelectorAll('.btn:not(#save-btn):not(#reset-btn)').forEach(el => {
        el.addEventListener('click', () => playTone(900, 0.1, 0.15));
      });
      // Unique sound for reset button
      const resetButton = document.getElementById('reset-btn');
      if (resetButton) {
        resetButton.addEventListener('click', () => playTone(1000, 0.1, 0.15));
      }
      // Play tone on export format change
      const formatSelect = document.getElementById('export-format');
      if (formatSelect) {
        formatSelect.addEventListener('change', () => playTone(1100, 0.07, 0.1));
      }
      // Unique sound for save button
      const saveButton = document.getElementById('save-btn');
      if (saveButton) {
        saveButton.addEventListener('click', () => {
          // two-tone ascending chime
          playTone(1200, 0.08, 0.2);
          setTimeout(() => playTone(1500, 0.08, 0.2), 80);
        });
      }
    });
  </script>
  <!-- Custom image editor functionality without TUI -->
  <!-- Load TensorFlow.js and BodyPix for client-side background removal -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0/dist/body-pix.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const fileInput = document.getElementById('file-input');
      const uploadZone = document.getElementById('upload-zone');
      const uploadBtn = document.getElementById('upload-btn');
      const startEditing = document.getElementById('start-editing');
      const btnLoad = document.getElementById('btn-load');
      const downloadBtn = document.getElementById('download-btn');
      const resetBtn = document.getElementById('reset-btn');
      const saveBtn = document.getElementById('save-btn');
      const filterCards = document.querySelectorAll('.filter-cards .card:not(.random-card)');
      // Adjustment panel tabs and panels
      const adjustmentCards = document.querySelectorAll('.adjustment-cards .card:not(.random-card)');
      const adjustmentControls = document.querySelectorAll('.adjustment-controls');
      const brightnessSlider = document.getElementById('brightness');
      const contrastSlider = document.getElementById('contrast');
      const saturationSlider = document.getElementById('saturation');
      const vibranceSlider = document.getElementById('vibrance');
      const noiseSlider = document.getElementById('noise');
      const pixelateSlider = document.getElementById('pixelate');
      const rotationSlider = document.getElementById('rotation-angle');
      const rotateLeftBtn = document.getElementById('btn-rotate-left');
      const rotateRightBtn = document.getElementById('btn-rotate-right');
      const flipXBtn = document.getElementById('btn-flip-x');
      const flipYBtn = document.getElementById('btn-flip-y');
      const rotationValueDisplay = rotationSlider && rotationSlider.nextElementSibling;
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      let originalImage = new Image();
      let isLoaded = false;
      let state = { filter: 'normal', brightness: 100, contrast: 100, saturation: 100, vibrance: 0, noise: 0, pixelate: 1, rotation: 0, flipH: false, flipV: false, zoom: 1 };
      // Zoom controls
      const zoomInBtn = document.getElementById('btn-zoom-in');
      const zoomOutBtn = document.getElementById('btn-zoom-out');
      const zoomValueDisplay = document.getElementById('zoom-value');
      const minZoom = 0.1, maxZoom = 5, zoomStep = 0.1;
      function updateZoomDisplay() {
        if (zoomValueDisplay) zoomValueDisplay.textContent = Math.round(state.zoom * 100) + '%';
      }
      // Prepare BodyPix model and mask canvas for BG removal
      let bodyPixModel = null;
      let maskCanvas = null;
      // Progress overlay elements
      const progressOverlay = document.getElementById('progress-overlay');
      const progressMessage = document.getElementById('progress-message');
      function showProgress(msg) {
        if (progressMessage) progressMessage.textContent = msg;
        if (progressOverlay) progressOverlay.classList.add('visible');
      }
      function hideProgress() {
        if (progressOverlay) progressOverlay.classList.remove('visible');
      }
      async function loadBodyPixModel() {
        if (bodyPixModel) return bodyPixModel;
        showProgress('Loading background removal model...');
        bodyPixModel = await bodyPix.load();
        hideProgress();
        showNotification('Background removal model loaded');
        return bodyPixModel;
      }
      // Generate a mask canvas where foreground is opaque and background transparent
      async function generateMask(imageEl) {
        const net = await loadBodyPixModel();
        const segmentation = await net.segmentPerson(imageEl, {
          internalResolution: 'medium',
          segmentationThreshold: 0.7
        });
        const w = imageEl.width;
        const h = imageEl.height;
        const mCanvas = document.createElement('canvas');
        mCanvas.width = w;
        mCanvas.height = h;
        const mCtx = mCanvas.getContext('2d');
        const imgData = mCtx.createImageData(w, h);
        const data = imgData.data;
        for (let i = 0; i < segmentation.data.length; i++) {
          if (segmentation.data[i] === 1) {
            data[i * 4 + 3] = 255;
          }
        }
        mCtx.putImageData(imgData, 0, 0);
        return mCanvas;
      }
      // Crop support
      const cropOverlay = document.getElementById('crop-overlay');
      const applyCropBtn = document.getElementById('btn-apply-crop');
      const cancelCropBtn = document.getElementById('btn-cancel-crop');
      let isCropping = false;
      let cropStartX = 0, cropStartY = 0;
      let cropRectEl = null;
      function enableCropMode() {
        if (cropOverlay) {
          cropOverlay.style.display = 'block';
          cropOverlay.addEventListener('mousedown', onCropMouseDown);
        }
      }
      function disableCropMode() {
        if (cropOverlay) {
          cropOverlay.style.display = 'none';
          cropOverlay.removeEventListener('mousedown', onCropMouseDown);
        }
        if (cropRectEl) {
          cropRectEl.remove(); cropRectEl = null;
        }
        isCropping = false;
      }
      function onCropMouseDown(e) {
        if (!cropOverlay) return;
        isCropping = true;
        // Remove any existing crop rectangle from previous draw
        if (cropRectEl) {
          cropRectEl.remove();
          cropRectEl = null;
        }
        // Use offset to get coordinates relative to overlay
        cropStartX = e.offsetX;
        cropStartY = e.offsetY;
        // Create new crop rectangle
        cropRectEl = document.createElement('div');
        cropRectEl.className = 'crop-rect';
        cropOverlay.appendChild(cropRectEl);
        cropRectEl.style.left = cropStartX + 'px';
        cropRectEl.style.top = cropStartY + 'px';
        cropRectEl.style.width = '0px';
        cropRectEl.style.height = '0px';
        cropOverlay.addEventListener('mousemove', onCropMouseMove);
        document.addEventListener('mouseup', onCropMouseUp);
      }
      function onCropMouseMove(e) {
        if (!isCropping || !cropRectEl) return;
        // Use offset to get current mouse position relative to overlay
        const x = e.offsetX;
        const y = e.offsetY;
        let w = x - cropStartX;
        let h = y - cropStartY;
        if (w < 0) {
          cropRectEl.style.left = x + 'px'; w = -w;
        } else {
          cropRectEl.style.left = cropStartX + 'px';
        }
        if (h < 0) {
          cropRectEl.style.top = y + 'px'; h = -h;
        } else {
          cropRectEl.style.top = cropStartY + 'px';
        }
        cropRectEl.style.width = w + 'px';
        cropRectEl.style.height = h + 'px';
      }
      function onCropMouseUp(e) {
        isCropping = false;
        if (cropOverlay) {
          cropOverlay.removeEventListener('mousemove', onCropMouseMove);
        }
        document.removeEventListener('mouseup', onCropMouseUp);
      }
      function resetState() {
        state = { filter: 'normal', brightness: 100, contrast: 100, saturation: 100, vibrance: 0, noise: 0, pixelate: 1, rotation: 0, flipH: false, flipV: false, zoom: 1 };
        // Clear any previous background mask
        maskCanvas = null;
        // Reset filter and adjustment panels
        filterCards.forEach(c => c.classList.toggle('selected', c.dataset.filter === state.filter));
        adjustmentCards.forEach(c => c.classList.toggle('selected', c.dataset.adjustment === 'basic'));
        adjustmentControls.forEach(panel => panel.style.display = panel.id === 'basic-controls' ? 'block' : 'none');
        // Reset sliders
        if (brightnessSlider) { brightnessSlider.value = 0; brightnessSlider.nextElementSibling.textContent = 0; }
        if (contrastSlider) { contrastSlider.value = 0; contrastSlider.nextElementSibling.textContent = 0; }
        if (saturationSlider) { saturationSlider.value = 0; saturationSlider.nextElementSibling.textContent = 0; }
        if (vibranceSlider) { vibranceSlider.value = 0; vibranceSlider.nextElementSibling.textContent = 0; }
        if (noiseSlider) { noiseSlider.value = 0; noiseSlider.nextElementSibling.textContent = 0; }
        if (pixelateSlider) { pixelateSlider.value = 1; pixelateSlider.nextElementSibling.textContent = 1; }
        if (rotationSlider) { rotationSlider.value = 0; rotationValueDisplay && (rotationValueDisplay.textContent = '0°'); }
        updateCanvas();
        if (zoomValueDisplay) updateZoomDisplay();
      }
      function updateCanvas() {
        if (!isLoaded) return;
        const cw = canvas.width, ch = canvas.height;
        // Dimensions for drawing
        const iw = originalImage.width, ih = originalImage.height;
        const baseScale = Math.min(cw/iw, ch/ih);
        const currentScale = baseScale * state.zoom;
        const dw = iw * currentScale, dh = ih * currentScale;
        // Offscreen canvas for filters
        const off = document.createElement('canvas'); off.width = cw; off.height = ch;
        const offCtx = off.getContext('2d');
        // Apply preset filter
        const presetMap = {
          normal: '',
          vintage: 'sepia(0.4) contrast(0.9) brightness(1.1)',
          grayscale: 'grayscale(1)',
          sepia: 'sepia(1)',
          sepia2: 'sepia(0.8) brightness(1.2)',
          blur: 'blur(3px)',
          invert: 'invert(1)'
        };
        const preset = presetMap[state.filter] || '';
        offCtx.filter = (`${preset} brightness(${state.brightness}%) contrast(${state.contrast}%) saturate(${state.saturation}%) saturate(${state.vibrance + 100}%)`).trim();
        offCtx.translate(cw/2, ch/2);
        offCtx.rotate(state.rotation * Math.PI / 180);
        offCtx.scale(state.flipH ? -1 : 1, state.flipV ? -1 : 1);
        offCtx.drawImage(originalImage, -dw/2, -dh/2, dw, dh);
        offCtx.setTransform(1, 0, 0, 1, 0, 0);
        offCtx.filter = 'none';
        // Draw to main canvas with pixelation
        ctx.clearRect(0, 0, cw, ch);
        if (state.pixelate > 1) {
          const p = state.pixelate;
          const smallW = Math.ceil(cw / p), smallH = Math.ceil(ch / p);
          const small = document.createElement('canvas'); small.width = smallW; small.height = smallH;
          const smallCtx = small.getContext('2d');
          smallCtx.drawImage(off, 0, 0, smallW, smallH);
          ctx.imageSmoothingEnabled = false;
          ctx.drawImage(small, 0, 0, cw, ch);
          ctx.imageSmoothingEnabled = true;
        } else {
          ctx.drawImage(off, 0, 0);
        }
        // Apply background mask if BG Remove filter selected
        if (state.filter === 'bg-remove' && maskCanvas) {
          ctx.globalCompositeOperation = 'destination-in';
          ctx.drawImage(maskCanvas, 0, 0, cw, ch);
          ctx.globalCompositeOperation = 'source-over';
        }
        // Apply noise
        if (state.noise > 0) {
          const imageData = ctx.getImageData(0, 0, cw, ch);
          const data = imageData.data;
          const noiseIntensity = state.noise / 1000;
          for (let i = 0; i < data.length; i += 4) {
            const rand = (Math.random() * 2 - 1) * 255 * noiseIntensity;
            data[i] += rand;
            data[i + 1] += rand;
            data[i + 2] += rand;
          }
          ctx.putImageData(imageData, 0, 0);
        }
      }
      function showNotification(msg) {
        const n=document.createElement('div'); n.className='notification'; n.textContent=msg; document.body.appendChild(n);
        setTimeout(()=>n.classList.add('visible'),10);
        setTimeout(()=>{n.classList.remove('visible'); setTimeout(()=>n.remove(),300);},3000);
      }
      function handleFile(file) {
        const reader=new FileReader(); reader.onload=e=>{ originalImage.onload=()=>{ isLoaded=true; resetState(); [downloadBtn,resetBtn,saveBtn].forEach(b=>b&&b.classList.remove('disabled')); startEditing&&(startEditing.style.display='none'); uploadZone&&uploadZone.classList.add('hidden'); showNotification('Image loaded'); }; originalImage.src=e.target.result; }; reader.readAsDataURL(file);
      }
      [uploadBtn,startEditing,btnLoad].forEach(b=>{ if(!b)return; b.addEventListener('click',e=>{e.preventDefault();fileInput&&fileInput.click();});});
      fileInput&&fileInput.addEventListener('change', e => { e.target.files[0] && handleFile(e.target.files[0]); });
      if (uploadZone) {
        ['dragover','dragenter'].forEach(evt => uploadZone.addEventListener(evt, e => { e.preventDefault(); uploadZone.style.borderColor = 'var(--primary)'; }));
        ['dragleave','drop','dragend'].forEach(evt => uploadZone.addEventListener(evt, e => { e.preventDefault(); uploadZone.style.borderColor = '#ddd'; if (evt === 'drop' && e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); }));
      }
      // Adjustment panel switching
      adjustmentCards.forEach(card => {
        card.addEventListener('click', () => {
          adjustmentCards.forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          adjustmentControls.forEach(panel => panel.style.display = 'none');
          const panel = document.getElementById(`${card.dataset.adjustment}-controls`);
          if (panel) {
            // Show adjustment panel; use flex for crop controls to align buttons
            panel.style.display = card.dataset.adjustment === 'crop' ? 'flex' : 'block';
          }
          // Enable crop overlay if crop adjustment selected, else disable
          if (card.dataset.adjustment === 'crop') {
            enableCropMode();
          } else {
            disableCropMode();
          }
        });
      });
      // Handle filter selection, including async BG removal
      filterCards.forEach(c => {
        c.addEventListener('click', async () => {
          filterCards.forEach(x => x.classList.remove('selected'));
          c.classList.add('selected');
          const f = c.dataset.filter;
          if (f === 'bg-remove') {
            showProgress('Removing background...');
            if (!maskCanvas) {
              maskCanvas = await generateMask(originalImage);
            }
            hideProgress();
            state.filter = 'bg-remove';
            updateCanvas();
            showNotification('Background removed');
          } else {
            state.filter = f;
            updateCanvas();
          }
        });
      });
      // Random filter selector
      const randomCard = document.querySelector('.filter-cards .random-card');
      if (randomCard) {
        randomCard.addEventListener('click', () => {
          const filters = Array.from(filterCards).map(c => c.dataset.filter);
          const randomFilter = filters[Math.floor(Math.random() * filters.length)];
          filterCards.forEach(c => c.classList.remove('selected'));
          const card = document.querySelector(`.filter-cards .card[data-filter="${randomFilter}"]`);
          if (card) card.classList.add('selected');
          state.filter = randomFilter;
          updateCanvas();
          showNotification('Random filter: ' + randomFilter);
        });
      }
      [[brightnessSlider,'brightness'],[contrastSlider,'contrast'],[saturationSlider,'saturation']].forEach(([slider,key])=>{if(!slider)return;const disp=slider.nextElementSibling;slider.addEventListener('input',()=>{const val=Number(slider.value);if(key==='brightness')state.brightness=(val/255)*100+100;else state[key]=val+100;disp.textContent=val;updateCanvas();});});
      // Color adjustment sliders
      if (vibranceSlider) {
        const disp = vibranceSlider.nextElementSibling;
        vibranceSlider.addEventListener('input', () => {
          const val = Number(vibranceSlider.value);
          state.vibrance = val;
          disp.textContent = val;
          updateCanvas();
        });
      }
      if (noiseSlider) {
        const disp = noiseSlider.nextElementSibling;
        noiseSlider.addEventListener('input', () => {
          const val = Number(noiseSlider.value);
          state.noise = val;
          disp.textContent = val;
          updateCanvas();
        });
      }
      if (pixelateSlider) {
        const disp = pixelateSlider.nextElementSibling;
        pixelateSlider.addEventListener('input', () => {
          const val = Number(pixelateSlider.value);
          state.pixelate = val;
          disp.textContent = val;
          updateCanvas();
        });
      }
      rotationSlider&&rotationSlider.addEventListener('input',()=>{state.rotation=Number(rotationSlider.value);rotationValueDisplay&&(rotationValueDisplay.textContent=state.rotation+'°');updateCanvas();});
      rotateLeftBtn&&rotateLeftBtn.addEventListener('click',()=>{state.rotation-=90;rotationSlider.value=state.rotation;rotationValueDisplay&&(rotationValueDisplay.textContent=state.rotation+'°');updateCanvas();});
      rotateRightBtn&&rotateRightBtn.addEventListener('click',()=>{state.rotation+=90;rotationSlider.value=state.rotation;rotationValueDisplay&&(rotationValueDisplay.textContent=state.rotation+'°');updateCanvas();});
      flipXBtn&&flipXBtn.addEventListener('click',()=>{state.flipH=!state.flipH;updateCanvas();});
      flipYBtn&&flipYBtn.addEventListener('click',()=>{state.flipV=!state.flipV;updateCanvas();});
      downloadBtn&&downloadBtn.addEventListener('click',()=>{const mime=document.getElementById('export-format')?.value||'image/png';const ext=mime==='image/jpeg'?'jpg':mime==='image/webp'?'webp':'png';canvas.toBlob(b=>saveAs(b,`downloaded.${ext}`),mime);showNotification('Image downloaded');});
      saveBtn&&saveBtn.addEventListener('click',()=>{const mime=document.getElementById('export-format')?.value||'image/png';const ext=mime==='image/jpeg'?'jpg':mime==='image/webp'?'webp':'png';canvas.toBlob(b=>saveAs(b,`edited.${ext}`),mime);showNotification('Image saved');});
      resetBtn&&resetBtn.addEventListener('click',()=>{resetState();showNotification('Reset');});
      // Crop apply/cancel
      applyCropBtn&&applyCropBtn.addEventListener('click',()=>{
        if (cropRectEl) {
          const x = parseInt(cropRectEl.style.left,10);
          const y = parseInt(cropRectEl.style.top,10);
          const w = parseInt(cropRectEl.style.width,10);
          const h = parseInt(cropRectEl.style.height,10);
          if (w>0 && h>0) {
            const temp = document.createElement('canvas'); temp.width=w; temp.height=h;
            temp.getContext('2d').drawImage(canvas, x, y, w, h, 0, 0, w, h);
            const dataURL = temp.toDataURL();
            originalImage = new Image();
            originalImage.onload = ()=>{ isLoaded=true; updateCanvas(); disableCropMode(); showNotification('Crop applied'); };
            originalImage.src = dataURL;
          }
        }
      });
      cancelCropBtn&&cancelCropBtn.addEventListener('click',()=>{ disableCropMode(); showNotification('Crop canceled'); });
      // Zoom in/out handlers
      zoomInBtn&&zoomInBtn.addEventListener('click',()=>{state.zoom=Math.min(state.zoom+zoomStep,maxZoom);updateZoomDisplay();updateCanvas();});
      zoomOutBtn&&zoomOutBtn.addEventListener('click',()=>{state.zoom=Math.max(state.zoom-zoomStep,minZoom);updateZoomDisplay();updateCanvas();});
    });
  </script>

</body>
</html>